---
title: 'Homework 5: Regression and Wrangling'
output: html_document
---
```{r, message=FALSE}
library(dslabs)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(readr)
library(stringr)
```

### Question 1
Describe what the `unite()` function does.

Solution: Unites two columns into one; the inverse of separate.

### Question 2
Read the following data set into R:
```{r, message=FALSE}
data <-read_csv("https://raw.githubusercontent.com/datasciencelabs/data/master/ny_airquality.csv")
```

Split the Date variable into year, month and day. Then compute the average wind speed for each month. What was the average wind speed in September?

* 11.62
* **10.18**
* 10.27
* 8.79
* 8.94

Solution:
```{r, warning = FALSE, message=FALSE}
library(lubridate)
data <- data %>% mutate(month = month(Date)) %>%
        group_by(month) %>%
        summarize(avg = mean(Wind))
data
```

### Question 3
For this question we will use the following two tables:
```{r, message=FALSE}
master <- read_csv("https://raw.githubusercontent.com/datasciencelabs/data/master/Master.csv")
player_info <- master %>% select(playerID, nameFirst, nameLast, birthYear, height)
salaries <- read_csv("https://raw.githubusercontent.com/datasciencelabs/data/master/Salaries.csv")
```

Create a table with one row for each player that shows their average salary. Use one of the dplyr join functions to add average salaries to the player_info table.
Of the players born after 1986, who had the highest average salary?

* Justin Upton
* Bruce Jay
* **Masahiro Tanaka**
* Buster Posey

Solution:
```{r}
avg_salary <- salaries %>% group_by(playerID) %>%
              summarize(avg_salary = mean(salary))

player_info <- left_join(player_info, avg_salary, by = 'playerID')

player_info <- player_info %>% filter(birthYear > 1986) %>%
               arrange(desc(avg_salary))
player_info
```

### Question 4

Load the Teams data set from the Lahman library of baseball statistics. What was the observed correlation between team home runs (HR) and team base-on-balls (BB) in 1999?

* **0.345**
* 0.833
* 0.023
* Impossible to compute

Solution:
```{r}
library(Lahman)
subset <- Teams %>% filter(yearID == 1999) %>% select(HR, BB)
cor(subset$HR, subset$BB)
```

### Question 5
Read the following data set into R:

```{r, message=FALSE}
ny_airquality <- read_csv("https://raw.githubusercontent.com/datasciencelabs/data/master/ny_airquality.csv")
```

Use the tidyr `separate` function to split the `Date` variable into year, month and day. Then use the `summarize` function to compute the average temperature for each month. What was the average temperature in July?

* 65 degrees Fahrenheit
* 88 degrees Fahrenheit
* 76 degrees Fahrenheit
* **84 degrees Fahrenheit**

Solution:
```{r, warning = FALSE, message=FALSE}
library(lubridate)
data <- ny_airquality %>% mutate(month = month(Date)) %>%
        group_by(month) %>%
        summarize(avg = mean(Temp))
data
```

### Question 6
Read in [this data](https://raw.githubusercontent.com/datasciencelabs/data/master/midterm2-shoe-size.csv). It includes *results* from a math test administered to a random sample of students in an elementary school.

Explore the *relationship* between the columns, in particular, note the correlation between *shoe size* and *math scores*. Which of the following conclusions would you draw from this data?


* Shoe size and math ability are clearly not related. Thus, the observed correlation is 0.
* Children with small feet get made fun of and the pressure makes them not test well.
* There must be a mistake in the data because the correlation between scores and shoe size is 0.95!
* **Grade is a confounding factor and explains the observed high correlation. If we stratify by grade there is no signifiant correlation.**

Solution:
```{r, message=FALSE, warning=FALSE}
test <- read_csv("https://raw.githubusercontent.com/datasciencelabs/data/master/midterm2-shoe-size.csv")
```

```{r}
by_grade <- test %>% group_by(grade) %>% summarise(corr = cor(shoe_size, math_score))
by_grade
```


### Question 7
After the 2008 Olympics, a small country that will remain unnamed was very proud of the fact that they won more medals than any previous year.

However, Mr. Downer, the president of the Olympic committee, warned the athletes to not rest on their laurels (as he had seen many times).

He noted that *the best performing* small countries in any given year *rarely matched their performance* 4 years later.

Which statement best explains this observation?

* Data shows that athletes that win 4 or more medals tend to win only about 3 in the next Olympics. Clearly they become overconfident and don't train as hard.
* **This is simply an example of the regression fallacy.**
* Other small countries are inspired to train harder, thus taking some of the medals that would otherwise go to Mr. Downer's team.
* To win all the medals they probably overspent and have no money left to train for the next Olympics.


### Question 8
Load the Lahman library of baseball statistics. We want to estimate the effect of team bases on balls (BB) on team runs (R) using the following model:

$R = \alpha + BB\beta + \epsilon$

We want to estimate $\beta$ using the data from just one year. Assume the model holds for each year starting in 1961. Which of the following best represents an approximate 95% confidence interval for a least squares estimate of $\beta$ **based on data from just one year**?

* **[0.1, 0.9]**
* [0.6, 0.7]
* [0.3, 0.75]
* [0.47, 0.58]

Solution:
```{r}
library(broom)
library(Lahman)
temp <- Teams %>% filter(yearID >= 1961) %>%
          group_by(yearID) %>%
          do(tidy(lm(R ~ BB, data = .), conf.int = TRUE)) %>%
          filter(term == "BB")

quantile(temp$estimate, c(.025, .975))
```

The best answer is [0.1, 0.9].

### Question 9
Install and load the `babynames` package. This package contains 3 datatsets. The `babynames` dataset contains the number of children of each sex given each name for each year from 1880 to 2017. The information is contained in a data frame with five variables: `year`, `sex`, `name`, `n` and `prop` (n divided by total number of applicants in that year, which means proportions are of people of that sex with that name born in that year). You can read more about the dataset here: https://cran.r-project.org/web/packages/babynames/babynames.pdf

Using the babynames dataset, how many boy names contain the string ZZ, Zz, zz or zZ?

Solution:
```{r, message=FALSE}
#install.packages("babynames")
library(stringr)
library(babynames)
library(dplyr)
data(babynames)
```

```{r}
# Filter boy names, make all letters lowercase, group by name
# since the same name can be repeated for different years and we
# want unique names.
boys  <- babynames %>% 
         filter(sex == "M") %>% 
		     mutate(name = str_to_lower(name)) %>%
         group_by(name) %>%
         summarize(n = n())

# Look for pattern "zz" in boys
contains_zz <- str_detect(boys$name, "zz")

# How many names contain "zz"?
sum(contains_zz)
```

### Question 10
How many girl names contain the string mira or Mira?

Solution:
```{r}
girls <- babynames %>% 
         filter(sex == "F") %>%
	       mutate(name = str_to_lower(name)) %>%
         group_by(name) %>%
         summarize(n = n()) 

contains_mira <- str_detect(girls$name, "mira")
sum(contains_mira)
```


### Question 11
How many girl names have at most 1 letter "a"? Specifically, how many have at most 1 uppercase or lowercase "a"?

Solution:
```{r}
# The pattern is start of the string, 0 or more characters (besides a) followed by 
# 0 or 1 a followed by 0 or more characters (besides a) then the end of the string
contains_a <- str_detect(str_to_lower(girls$name), "^[b-z]*a?[b-z]*$")
sum(contains_a)
```

### Question 12
How many girl names contain 1 or more letter "a"s? Specifically, how many have 1 or more uppercase or lowercase "a"?

Solution:
```{r}
contains_a <- str_detect(girls$name, "a")
sum(contains_a)
```

### Question 13
How many boy names start with a vowel and end with a vowel?

Solution:
```{r}
# The patter is start of the string, then a vowel, then 0 or more of any 
# character, then a vowel and the end of the string
contains_vowel <- str_detect(str_to_lower(boys$name), "^[aeiou].*[aeiou]$")
sum(contains_vowel)
```


### Question 14

Low sodium levels, also known as hyponatremia, have emerged as a leading cause of race-related death among marathon runners. A fairly recent [study](https://www.nejm.org/doi/full/10.1056/NEJMoa043901) investigated a cohort of marathon runners in the US to identify the principal risk factors for low sodium levels.  All registered participants 18 years or older were eligible for inclusion, and subjects were approached at random during registration and invited to participate. **The primary hypothesis of the study was that excessive consumption of fluids is associated with lower serum sodium levels in marathon runners**. Researchers were also interested in assessing other factors that may predict dangerously low levels, generally thought to be below 135 milli-equivalents per liter. Accordingly, independent variables analyzed for association with serum sodium level included weight change during the race, and self-report of fluid intake including volume and frequency. Other predictors considered a priori included: female gender (dichotomous), BMI, training pace, number of previous marathons, marathon duration, use of nonsteroidal anti-inflammatory medications (NSAID; dichotomous), age, and non-white race (dichotomous).

A sample of the original data have been saved in the file `marathon.csv`. This sample does not contain any missing data. The variable descriptions are below.

* `sodium`: (serum sodium level, in milli-equivalents per liter)
* `female`: (1 = female, 0 = male)
* `age`: (years)
* `bmi`: (pre-race wt/ht-squared, using the appropriate units)
* `fluidfr3`: (fluid frequency drank through the marathon, coded as 1=every mile, 2=every other mile, 3=every 3rd mile or less)
* `howmany`: (number of prior marathons run)
* `lwobup01`: (1 = reported NSAID use, 0 = not)
* `runtime`: (marathon running time, in minutes) 
* `trainpse`: (training pace for a one-mile run, in seconds) 
* `urinat3p`: (1 = urinated 3 or more times during the race, 0 = not)
* `wateld01`: (1 = reported water loading prior to the race, 0 = not)
* `wtdiff`: (weight change during the marathon in kilograms)

While the authors used logistic regression to study the variables associated with hyponatremia (dichotomous sodium level), we will use linear regression to investigate the variables associated with continuous sodium level.

Fit the following model:

$$
\hat{\text{sodium}} = \beta_0 + \beta_1 \text{fluidfr3}
$$
What is the estimate for $\beta_1$?

Solution:
```{r, warning=FALSE, message=FALSE}
library(readr)
library(tidyverse)
library(broom)
```

```{r, message=FALSE, warning=FALSE}
marathon <- read_csv("https://raw.githubusercontent.com/datasciencelabs/data/master/marathon.csv")
```

```{r}
marathon %>% do(tidy(lm(sodium ~ fluidfr3, data = .)))
```

$\hat\beta_1$ = 1.36

### Question 15
Is the coefficient for `fluidfr3` significantly different from 0 at the $\alpha = 0.05$ level?

Solution:
Yes, the frequency of fluids drank significantly associated with sodium level; the p-value for $\beta_1$ < 0.05.

### Question 16
Now fit the model:
$$
\hat{\text{sodium}} = \beta_0 + \beta_1 \text{fluidfr3} + \beta_2 \text{wtdiff}
$$

Is the coefficient for `fluidfr3` significantly different from 0 at the $\alpha = 0.05$ level?

Solution:
```{r}
marathon %>% do(tidy(lm(sodium ~ fluidfr3 + wtdiff, data = .)))
```

No, the frequency of fluids drank significantly associated with sodium level; the p-value for $\beta_1$ = 0.1 > 0.05.
